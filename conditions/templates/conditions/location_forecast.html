{% extends 'conditions/base.html' %}
{% load static %}

{% block title %}{{ location.city }}, {{ location.country }} – Snorkel Forecast{% endblock %}

{% block meta %}
  <meta name="description" content="Snorkeling forecast for {{ location.city }}, {{ location.country }}. Wave height, wind speed, tides and sea temperature.">
  <meta property="og:title" content="{{ location.city }}, {{ location.country }} Snorkel Forecast - SnorkelForecast.com" />
  <meta property="og:description" content="Get accurate snorkeling forecasts for {{ location.city }}, {{ location.country }}." />
  <meta property="og:image" content="https://snorkelforecast.com{% url 'location_og_image' country=location.country_slug city=location.city_slug %}" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta name="twitter:image" content="https://snorkelforecast.com{% url 'location_og_image' country=location.country_slug city=location.city_slug %}" />
  <meta property="og:url" content="https://snorkelforecast.com{% url 'location_forecast' country=location.country_slug city=location.city_slug %}" />
  <meta name="twitter:card" content="summary_large_image" />
{% endblock %}

{% block content %}
  <nav aria-label="Breadcrumb" class="max-w-6xl mx-auto px-4 pt-4">
    <ol class="flex flex-wrap items-center gap-1 text-sm text-gray-600 ui-night:text-gray-300">
      <li><a href="{% url 'homepage' %}" class="hover:underline">Home</a></li>
      <li>/</li>
      <li><a href="{% url 'countries_index' %}" class="hover:underline">Countries</a></li>
      <li>/</li>
      <li><a href="/{% firstof location.country_slug %}/" class="hover:underline">{{ location.country }}</a></li>
      <li>/</li>
      <li class="text-gray-900 ui-night:text-gray-100" aria-current="page">{{ location.city }}</li>
    </ol>
  </nav>
  <section class="w-full max-w-6xl mx-auto px-4 py-4 sm:py-6">
    <div class="text-center">
      <h1 class="text-xl sm:text-2xl font-bold mb-2">Snorkel Forecast – {{ location.city }}, {{ location.country }}</h1>
      <p class="text-xs sm:text-sm text-gray-600 ui-night:text-gray-300">All times are in {{ timezone }}</p>
    </div>
    {# Detailed text summary of snorkel forecast #}
    {% if summary.total_hours > 0 %}
      <div class="card-enhanced p-4 sm:p-5 mb-6 w-full max-w-2xl">
      <h2 class="text-base sm:text-lg font-semibold mb-2">Forecast Summary</h2>
        {% with first=hours.0 last=hours|last %}
          <p class="mb-2 text-sm sm:text-base">
            Over the next {{ summary.total_hours }} hours (from
            {{ first.time|date:"D H:i" }} to {{ last.time|date:"D H:i" }}),
            snorkeling conditions will vary across excellent, good, fair and poor periods.
            Overall, there are
            <span class="font-medium">{{ rating_counts.excellent }}</span> excellent,
            <span class="font-medium">{{ rating_counts.good }}</span> good,
            <span class="font-medium">{{ rating_counts.fair }}</span> fair,
            and <span class="font-medium">{{ rating_counts.poor }}</span> poor hours.
          </p>
          {% if summary.ok_count > 0 %}
            <p class="text-sm sm:text-base">
              First suitable period begins {{ summary.earliest_ok|date:"D H:i" }}{% if summary.earliest_ok and summary.latest_ok and summary.earliest_ok != summary.latest_ok %} and lasts until {{ summary.latest_ok|date:"D H:i" }}{% endif %}.
            </p>
          {% endif %}

          {% if daily_outlook %}
            <div class="mt-3">
              <h3 class="text-sm sm:text-base font-semibold mb-1">Daily outlook</h3>
              <ul class="text-sm sm:text-base space-y-1">
                {% for o in daily_outlook %}
                  <li>
                    <span class="font-medium">{{ o.label }}:</span>
                    {% if o.counts.excellent %}
                      {{ o.counts.excellent }}× excellent{% if o.top_rating == 'excellent' and o.top_start %} ({{ o.top_start|date:"H:i" }}{% if o.top_end and o.top_end != o.top_start %}–{{ o.top_end|date:"H:i" }}{% endif %}){% endif %}{% if o.counts.good or o.counts.fair or o.counts.poor %}, {% endif %}
                    {% endif %}
                    {% if o.counts.good %}
                      {{ o.counts.good }}× good{% if o.top_rating == 'good' and o.top_start %} ({{ o.top_start|date:"H:i" }}{% if o.top_end and o.top_end != o.top_start %}–{{ o.top_end|date:"H:i" }}{% endif %}){% endif %}{% if o.counts.fair or o.counts.poor %}, {% endif %}
                    {% endif %}
                    {% if o.counts.fair %}
                      {{ o.counts.fair }}× fair{% if o.top_rating == 'fair' and o.top_start %} ({{ o.top_start|date:"H:i" }}{% if o.top_end and o.top_end != o.top_start %}–{{ o.top_end|date:"H:i" }}{% endif %}){% endif %}{% if o.counts.poor %}, {% endif %}
                    {% endif %}
                    {% if o.counts.poor %}
                      {{ o.counts.poor }}× poor
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% endif %}
        {% endwith %}
      </div>
    {% else %}
      <p class="text-red-600 mb-6 text-center text-sm sm:text-base">Forecast data is currently unavailable.</p>
    {% endif %}

    <div class="card-enhanced p-4 sm:p-5 mb-6 w-full max-w-2xl mx-auto">
      <h2 class="text-base sm:text-lg font-semibold mb-2">Snorkel Score (next 24h)</h2>
      <div class="h-48 sm:h-64">
        <canvas id="scoreChart24" class="w-full h-full"></canvas>
      </div>
    </div>

    <div class="card-enhanced p-4 sm:p-5 mb-6 w-full max-w-2xl mx-auto">
      <h2 class="text-base sm:text-lg font-semibold mb-2">Snorkel Score (next 72h)</h2>
      <div class="h-48 sm:h-64">
        <canvas id="scoreChart" class="w-full h-full"></canvas>
      </div>
    </div>

    {% if tide_times %}
      <div class="card-enhanced p-4 sm:p-5 mb-6 w-full max-w-2xl mx-auto">
        <h2 class="text-base sm:text-lg font-semibold mb-2">Upcoming High Tides</h2>
        {% if next_early_high_tide %}
          <p class="text-sm sm:text-base mb-2">
            Next early morning high tide: {{ next_early_high_tide|date:"D H:i" }}
          </p>
        {% endif %}
        <p class="text-sm sm:text-base">
          {% for t in tide_times %}
            {{ t|date:"D H:i" }}{% if not forloop.last %}, {% endif %}
          {% endfor %}
        </p>
      </div>
    {% endif %}

    <div class="card-enhanced p-4 sm:p-5 mb-6 w-full max-w-2xl mx-auto">
      <h2 class="text-base sm:text-lg font-semibold mb-2">FAQs</h2>
      <p class="font-medium text-sm sm:text-base mb-1">When is the next safe snorkel window?</p>
      {% if next_window %}
        <p class="text-sm sm:text-base">
          The next suitable window starts {{ next_window.start|date:"D H:i" }}{% if next_window.end and next_window.end != next_window.start %} and lasts until {{ next_window.end|date:"D H:i" }}{% endif %}.
        </p>
      {% else %}
        <p class="text-sm sm:text-base">No safe snorkeling window is expected in the next 72 hours.</p>
      {% endif %}
    </div>

    <div class="mt-6 sm:mt-8 w-full max-w-4xl mx-auto card-enhanced p-4 sm:p-6">
      <h2 class="text-base sm:text-lg font-semibold mb-4">Condition Trends (next 24h)</h2>
      <div class="space-y-6">
        <div class="h-48 sm:h-64">
          <canvas id="waveChart24" class="w-full h-full"></canvas>
        </div>
        <div class="h-48 sm:h-64">
          <canvas id="windChart24" class="w-full h-full"></canvas>
        </div>
        <div class="h-48 sm:h-64">
          <canvas id="tideChart24" class="w-full h-full"></canvas>
        </div>
        <div class="h-24 sm:h-32 flex flex-col justify-center">
          <div id="tempBar24" class="relative w-full h-8 bg-gray-200 rounded-full">
            <div id="tempIdeal24" class="absolute inset-y-0 bg-green-200"></div>
            <div id="tempAvg24" class="absolute inset-y-0 w-1 bg-orange-500"></div>
          </div>
          <p id="tempLabel24" class="text-center mt-2 text-sm"></p>
        </div>
      </div>
    </div>

    <div class="mt-6 sm:mt-8 w-full max-w-4xl mx-auto card-enhanced p-4 sm:p-6">
      <h2 class="text-base sm:text-lg font-semibold mb-4">Condition Trends (next 72h)</h2>
      <div class="space-y-6">
        <div class="h-48 sm:h-64">
          <canvas id="waveChart" class="w-full h-full"></canvas>
        </div>
        <div class="h-48 sm:h-64">
          <canvas id="windChart" class="w-full h-full"></canvas>
        </div>
        <div class="h-48 sm:h-64">
          <canvas id="tideChart" class="w-full h-full"></canvas>
        </div>
        <div class="h-24 sm:h-32 flex flex-col justify-center">
          <div id="tempBar" class="relative w-full h-8 bg-gray-200 rounded-full">
            <div id="tempIdeal" class="absolute inset-y-0 bg-green-200"></div>
            <div id="tempAvg" class="absolute inset-y-0 w-1 bg-orange-500"></div>
          </div>
          <p id="tempLabel" class="text-center mt-2 text-sm"></p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-6 sm:grid-cols-12 gap-1 text-xs max-w-6xl mx-auto mt-6">
      {% for h in hours %}
        {% with alpha=h.score|floatformat:2 %}
        <div class="forecast-cell p-2 sm:p-2 rounded-lg text-center min-h-[64px] sm:min-h-[56px] flex flex-col justify-center" style="background-color: rgba(74, 222, 128, {{ alpha }});">
          <time datetime="{{ h.time|date:'c' }}" class="text-xs font-medium" aria-label="{{ h.time|date:'D H:i' }} rating {{ h.rating }} score {{ h.score|floatformat:2 }}">
            <span class="block sm:hidden">{{ h.time|date:'D'|truncatechars:3 }}</span>
            <span class="hidden sm:block">{{ h.time|date:'D H:i'|safe }}</span>
            <span class="block sm:hidden text-[10px]">{{ h.time|date:'H:i' }}</span>
          </time>
          <span class="text-[10px] sm:text-xs mt-1 capitalize">{{ h.rating }}</span>
        </div>
        {% endwith %}
      {% endfor %}
    </div>

    {# Explanation of conditions #}
    <div class="mt-6 sm:mt-8 w-full max-w-4xl mx-auto card-enhanced p-4 sm:p-6">
        <h2 class="text-base sm:text-lg font-semibold mb-2">How We Calculate Conditions</h2>
        <p class="text-sm sm:text-base">
            We consider snorkeling conditions to be ideal when all of the following criteria, fetched from the Open-Meteo API, are met during daylight hours (between sunrise and sunset):
        </p>
        <ul class="list-disc list-inside mt-2 text-sm sm:text-base space-y-1">
            <li><strong>Wave height</strong> is less than 0.3 meters.</li>
            <li><strong>Wind speed</strong> is below 4.5 meters/second.</li>
            <li><strong>Sea surface temperature</strong> is between 22°C and 29°C.</li>
            <li><strong>Within ±60&nbsp;min of high tide</strong> and currents ≤ 0.3&nbsp;m/s.</li>
        </ul>
    </div>

    {# Detailed table of snorkel conditions #}
    <div class="mt-6 sm:mt-8 w-full max-w-4xl mx-auto">
      <h2 class="text-base sm:text-lg font-semibold mb-2">Detailed Conditions</h2>
      <div class="responsive-table">
        <table class="w-full text-sm text-left text-gray-700 bg-white shadow rounded-lg text-night-muted bg-night-surface">
          <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
              <th scope="col" class="px-3 sm:px-6 py-3">Time</th>
              <th scope="col" class="px-3 sm:px-6 py-3 hidden sm:table-cell">Sunrise</th>
              <th scope="col" class="px-3 sm:px-6 py-3 hidden sm:table-cell">Sunset</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Wave Height (m)</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Wind Speed (m/s)</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Sea Temp (°C)</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Tide Height (m)</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Current (m/s)</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Score</th>
              <th scope="col" class="px-3 sm:px-6 py-3">Rating</th>
            </tr>
          </thead>
          <tbody>
            {% for h in hours %}
              <tr class="border-b hover:bg-gray-50">
                <th scope="row" class="px-3 sm:px-6 py-3 sm:py-4 font-medium text-gray-900 whitespace-nowrap text-xs sm:text-sm">
                  {{ h.time|date:"D H:i" }}
                </th>
                <td class="px-3 sm:px-6 py-3 sm:py-4 hidden sm:table-cell text-xs sm:text-sm">{{ h.sunrise|date:"H:i" }}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 hidden sm:table-cell text-xs sm:text-sm">{{ h.sunset|date:"H:i" }}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm {% if not h.wave_ok %}text-red-600 font-bold{% endif %}">
                  {{ h.wave_height|floatformat:2 }}
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm {% if not h.wind_ok %}text-red-600 font-bold{% endif %}">
                  {{ h.wind_speed|floatformat:2 }}
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm {% if not h.sst_ok %}text-red-600 font-bold{% endif %}">
                  {{ h.sea_surface_temperature|floatformat:2 }}
                </td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm">{{ h.sea_level_height|floatformat:2 }}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm {% if not h.slack_ok %}text-red-600 font-bold{% endif %}">{{ h.current_velocity|floatformat:2 }}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 font-bold text-xs sm:text-sm">{{ h.score|floatformat:2 }}</td>
                <td class="px-3 sm:px-6 py-3 sm:py-4 text-xs sm:text-sm capitalize">{{ h.rating }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <script>
      (function () {
        function initCharts() {
          // Theme-aware chart colors
          const isNight = document.body.classList.contains('ui-night');
          const axisColor = isNight ? 'rgb(209,213,219)' : 'rgb(55,65,81)';
          const gridColor = isNight ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.08)';
          const labels = [{% for h in hours %}'{{ h.time|date:"D H:i" }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
          const waveData = [{% for h in hours %}{{ h.wave_height|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const windData = [{% for h in hours %}{{ h.wind_speed|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const tempData = [{% for h in hours %}{{ h.sea_surface_temperature|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const scoreData = [{% for h in hours %}{{ h.score|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const tideData = [{% for h in hours %}{{ h.sea_level_height|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

          const labels24 = [{% for h in hours_24 %}'{{ h.time|date:"D H:i" }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
          const waveData24 = [{% for h in hours_24 %}{{ h.wave_height|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const windData24 = [{% for h in hours_24 %}{{ h.wind_speed|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const tempData24 = [{% for h in hours_24 %}{{ h.sea_surface_temperature|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const scoreData24 = [{% for h in hours_24 %}{{ h.score|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const tideData24 = [{% for h in hours_24 %}{{ h.sea_level_height|floatformat:2 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
          const waveThreshold = Array(labels.length).fill(0.3);
          const windThreshold = Array(labels.length).fill(4.5);
          const perfectThreshold = Array(labels.length).fill(0.8);
          const okThreshold = Array(labels.length).fill(0.6);
          const notGoodThreshold = Array(labels.length).fill(0.4);

          const waveThreshold24 = Array(labels24.length).fill(0.3);
          const windThreshold24 = Array(labels24.length).fill(4.5);
          const perfectThreshold24 = Array(labels24.length).fill(0.8);
          const okThreshold24 = Array(labels24.length).fill(0.6);
          const notGoodThreshold24 = Array(labels24.length).fill(0.4);

          const idealMin = 22;
          const idealMax = 29;
          const scaleMax = 35; // max temperature for scale
          const avgTemp = tempData.reduce((a, b) => a + b, 0) / tempData.length;
          const avgTemp24 = tempData24.reduce((a, b) => a + b, 0) / tempData24.length;

          // Position ideal range
          const idealEl = document.getElementById('tempIdeal');
          idealEl.style.left = `${(idealMin / scaleMax) * 100}%`;
          idealEl.style.width = `${((idealMax - idealMin) / scaleMax) * 100}%`;

          const idealEl24 = document.getElementById('tempIdeal24');
          idealEl24.style.left = `${(idealMin / scaleMax) * 100}%`;
          idealEl24.style.width = `${((idealMax - idealMin) / scaleMax) * 100}%`;

          // Position average marker
          const avgEl = document.getElementById('tempAvg');
          avgEl.style.left = `${(avgTemp / scaleMax) * 100}%`;

          const avgEl24 = document.getElementById('tempAvg24');
          avgEl24.style.left = `${(avgTemp24 / scaleMax) * 100}%`;

          // Label with average temperature
          document.getElementById('tempLabel').textContent = `Average Sea Temp: ${avgTemp.toFixed(1)}°C`;
          document.getElementById('tempLabel24').textContent = `Average Sea Temp: ${avgTemp24.toFixed(1)}°C`;

          const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { ticks: { color: axisColor }, grid: { color: gridColor } },
              y: { beginAtZero: true, ticks: { color: axisColor }, grid: { color: gridColor } }
            },
            plugins: { legend: { labels: { color: axisColor } } }
          };

          const scoreOptions = {
            ...commonOptions,
            scales: { ...commonOptions.scales, y: { ...commonOptions.scales.y, max: 1 } }
          };

          new Chart(document.getElementById('scoreChart24'), {
            type: 'line',
            data: {
              labels: labels24,
              datasets: [
                {
                  label: 'Snorkel Score',
                  data: scoreData24,
                  borderColor: 'rgb(107,33,168)',
                  backgroundColor: 'rgba(107,33,168,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Excellent (0.8)',
                  data: perfectThreshold24,
                  borderColor: 'rgb(34,197,94)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                },
                {
                  label: 'Good (0.6)',
                  data: okThreshold24,
                  borderColor: 'rgb(234,179,8)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                },
                {
                  label: 'Fair (0.4)',
                  data: notGoodThreshold24,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: scoreOptions
          });

          new Chart(document.getElementById('scoreChart'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Snorkel Score',
                  data: scoreData,
                  borderColor: 'rgb(107,33,168)',
                  backgroundColor: 'rgba(107,33,168,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Excellent (0.8)',
                  data: perfectThreshold,
                  borderColor: 'rgb(34,197,94)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                },
                {
                  label: 'Good (0.6)',
                  data: okThreshold,
                  borderColor: 'rgb(234,179,8)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                },
                {
                  label: 'Fair (0.4)',
                  data: notGoodThreshold,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: scoreOptions
          });

          new Chart(document.getElementById('waveChart24'), {
            type: 'line',
            data: {
              labels: labels24,
              datasets: [
                {
                  label: 'Wave Height (m)',
                  data: waveData24,
                  borderColor: 'rgb(59,130,246)',
                  backgroundColor: 'rgba(59,130,246,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Ideal Threshold (0.3 m)',
                  data: waveThreshold24,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: commonOptions
          });

          new Chart(document.getElementById('waveChart'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Wave Height (m)',
                  data: waveData,
                  borderColor: 'rgb(59,130,246)',
                  backgroundColor: 'rgba(59,130,246,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Ideal Threshold (0.3 m)',
                  data: waveThreshold,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: commonOptions
          });

          new Chart(document.getElementById('windChart24'), {
            type: 'line',
            data: {
              labels: labels24,
              datasets: [
                {
                  label: 'Wind Speed (m/s)',
                  data: windData24,
                  borderColor: 'rgb(34,197,94)',
                  backgroundColor: 'rgba(34,197,94,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Ideal Threshold (4.5 m/s)',
                  data: windThreshold24,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: commonOptions
          });

          new Chart(document.getElementById('windChart'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Wind Speed (m/s)',
                  data: windData,
                  borderColor: 'rgb(34,197,94)',
                  backgroundColor: 'rgba(34,197,94,0.3)',
                  fill: true,
                  tension: 0.3
                },
                {
                  label: 'Ideal Threshold (4.5 m/s)',
                  data: windThreshold,
                  borderColor: 'rgb(239,68,68)',
                  borderDash: [6,6],
                  pointRadius: 0,
                  fill: false
                }
              ]
            },
            options: commonOptions
          });

          new Chart(document.getElementById('tideChart24'), {
            type: 'line',
            data: {
              labels: labels24,
              datasets: [
                {
                  label: 'Tide Height (m)',
                  data: tideData24,
                  borderColor: 'rgb(56,189,248)',
                  backgroundColor: 'rgba(56,189,248,0.3)',
                  fill: true,
                  tension: 0.4
                }
              ]
            },
            options: commonOptions
          });

          new Chart(document.getElementById('tideChart'), {
            type: 'line',
            data: {
              labels,
              datasets: [
                {
                  label: 'Tide Height (m)',
                  data: tideData,
                  borderColor: 'rgb(56,189,248)',
                  backgroundColor: 'rgba(56,189,248,0.3)',
                  fill: true,
                  tension: 0.4
                }
              ]
            },
            options: commonOptions
          });

          // No chart for temperature; display average bar instead
        }

        function loadAndInit() {
          const s = document.createElement('script');
          s.src = '{% static "js/chart.umd.min.js" %}';
          s.async = true;
          s.onload = initCharts;
          s.onerror = function () {
            // Fallback to CDN if local asset missing (e.g., in dev)
            const cdn = document.createElement('script');
            cdn.src = 'https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js';
            cdn.async = true;
            cdn.onload = initCharts;
            document.head.appendChild(cdn);
          };
          document.head.appendChild(s);
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', loadAndInit);
        } else {
          loadAndInit();
        }
      })();
    </script>
  </section>
{% endblock %}
